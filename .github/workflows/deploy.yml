name: Deploy to IIS

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.x'
          
      - name: Build with dotnet 
        run: dotnet build --configuration Release -o ${{ env.DOTNET_ROOT }}/publish 
        
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: .net-app
          path: ${{ env.DOTNET_ROOT }}/publish
          
          
          
  deploy on IIS:
    runs-on: self-hosted
    needs: build 
    environment: 
      name: production 
      url: http://localhost:5000 
      steps:
        - name: Download artifact
          uses: actions/download-artifact@v2
          with:
            name: .net-app 
            
        - name: Deploy to IIS 
          shell: powershell
          run: |
            Start-Process powershell -Verb RunAs -ArgumentList "iisreset /stop"   
            xcopy /Y /S /I publish\* C:\inetpub\wwwroot\ServiceManagerApi\
            Start-Process powershell -Verb RunAs -ArgumentList "iisreset /start" 
          
          
          
          
          
          
          
          
          
          
#          run as administrator
#          Start-Process powershell -Verb RunAs -ArgumentList "iisreset /start"










#      - name: Build
#        run: |
#          dotnet restore
#          dotnet build --configuration Release
#
#
#      - name: Stop the website
#        run: |
#          Start-Process powershell -Verb RunAs -ArgumentList "Stop-WebAppPool -Name SmWebApiPool"
#          Start-Sleep -Seconds 10
#          
#          
#          #      - name: Remove the existing app from IIS
#          #        run: Start-Process powershell -Verb RunAs -ArgumentList 'Remove-WebApplication -Name $websiteName -Site $iisSiteName -ErrorAction Stop'
#
#      - name: Delete the existing files from the website folder
#        #        run: Start-Process powershell -Verb RunAs -ArgumentList "Get-ChildItem $publishPath -Exclude $webconfig, $appsettings -Recurse | Remove-Item -Recurse -Force"
#        #        run: Start-Process powershell -Verb RunAs -ArgumentList "Remove-Item -Path $publishPath -Recurse -Force -ErrorAction Stop -Exclude $webconfig, $appsettings"
#        #        run: Start-Process powershell -Verb RunAs -ArgumentList "Remove-Item C:\inetpub\wwwroot\ServiceManagerApi\* -Recurse -Force -Exclude web.config"
#        run: Start-Process powershell -Verb RunAs -ArgumentList "get-childitem 'C:\inetpub\wwwroot\ServiceManagerApi\' -Exclude *.config -recurse | remove-item -recurse -force"
#          
#          #      - name: Publish the app 
#          #        run: |
#          #          Start-Process powershell -Verb RunAs -ArgumentList "dotnet publish"
#          #          Start-Sleep -Seconds 10
#
#      - name: Copy the files to the website folder
#        run: Start-Process powershell -Verb RunAs -ArgumentList "Copy-Item -Path bin\Release\net6.0\* -Destination C:\inetpub\wwwroot\equip-service\ -Recurse -Force -Exclude web.config"
#
#      - name: Start the website
#        run: Start-Process powershell -Verb RunAs -ArgumentList "Start-WebAppPool -Name SmWebApiPool" 
